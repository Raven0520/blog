<extend name="Common/index"/>
<block name="header">
    <link href="/Public/css/plugins/jsTree/style.min.css" rel="stylesheet">
</block>

<block name="content">
    <div class="row">
        <div class="col-lg-6">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Menu List</h5>
                    <div class="ibox-tools">
                        <a class="add-link" data-toggle="modal" data-target="#add">
                            <i class="fa fa-plus"></i>
                        </a>
                        <a class="add-link" data-toggle="modal" data-target="#add" onclick="edit()">
                            <i class="fa fa-edit"></i>
                        </a>
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="tree">
                        <ul>
                            <li class="jstree-open">Site
                                <ul id="site" class="rule">
                                </ul>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Menu Detail</h5>
                    <div class="ibox-tools">
                        <a class="add-link" data-toggle="modal" data-target="#add">
                            <i class="fa fa-edit"></i>
                        </a>
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Previous</label>
                        <span id="Previous"></span>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Menu Type</label>
                        <span id="menu_type"></span>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Title</label>
                        <span id="title"></span>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">icon</label>
                        <span id="menu_icon"></span>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Rule</label>
                        <span id="rule"></span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal inmodal" id="add" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Add Menu</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Previous</label>
                            <div class="col-sm-9">
                                <select class="form-control m-b" name="sort_id">
                                    <option value="0">Top Menu</option>
                                    <foreach name="sort" item="vo">
                                        <option value="{$vo.id}">{$vo.title}</option>
                                    </foreach>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Menu Type</label>
                            <div class="col-sm-9">
                                <select class="form-control m-b" name="menu_type">
                                    <option value="0">Menu</option>
                                    <option value="1">Second Menu</option>
                                    <option value="2">Window</option>
                                    <option value="3">Button</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Title</label>
                            <div class="col-sm-9">
                                <input class="form-control m-b" name="title" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Icon</label>
                            <div class="col-sm-9">
                                <input class="form-control m-b" name="icon" onblur="getIcon(this.value)"/>
                                <span class="" id="icon" style="position: absolute; top: 5px; right: 24px; font-size: 24px;"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Rule</label>
                            <div class="col-sm-9">
                                <input class="form-control m-b" name="name" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="Save()">Save</button>
                </div>
            </div>
        </div>
    </div>
</block>


<block name="footer-end">
    <script src="/Public/js/plugins/jsTree/jstree.min.js"></script>
</block>

<block name="script">

    <style>
        .jstree-open > .jstree-anchor > .fa-folder:before {
            content: "\f07c";
        }

        .jstree-default .jstree-icon.none {
            width: 0;
        }
    </style>

    <script>
        $(function () {
            $('#site li').each(function (i) {
                $(this).click(function () {
                    console.log($(this).text());
                })
            });

            var icon = '{$icon}';
            var menu = '{$menu}';
            menu = JSON.parse(menu);
            icon = JSON.parse(icon);
            var types = {
                'default':{'icon':'fa fa-list'},
                'Add':{'icon':'fa fa-plus'},
                'Edit':{'icon':'fa fa-pencil'},
                'Del':{'icon':'fa fa-close'}
            };
            $.each(icon,function (i,v) {
                types[v.title] = {'icon':v.icon};
            });

            //加载菜单
            var html,type;
            $.each(menu,function (k,v) {
                if (v.sort_id == 0){
                    type = '{"type":"'+ v.title +'"}';
                    html = "<li data-jstree='"+ type +"')'><a href='#' onclick='info("+ v.id +")'>"+ v.title +"</a><ul id='sort_"+ v.id +"'></ul></li>";
                    $("#site").append(html);
                }else {
                    type = '{"type":"'+ v.title +'"}';
                    html = "<li id='second"+ v.id +"' data-jstree='"+ type +"'><button style='border: none;padding: 0' class='btn-link' onclick='info("+ v.id +")'>"+ v.title +"</button></li>";
                    $('#sort_' + v.sort_id).append(html);
                }
            });

            $('#tree').jstree({
                'core' : {
                    'check_callback' : true
                },
                'plugins' : [ 'types', 'dnd' ],
                'types' : types
            });
            

        });
        
        //获取菜单信息
        function info(id) {
            $.post("{:U('edit')}",{id:id},function (info) {
                $('#title').html(info.title);
                console.log(info);
                return;
            },"JSON");
        }

        function edit() {
            $('#jstree').on('change.jstree',function (e,data) {
                console.log(data.instance.get_node(data.selected[0]).id);
            })
        }

        //预览图标
        function getIcon(icon) {

            $('#icon').removeClass().addClass(icon);
            if (icon == '') {
                $('#icon').removeClass();
            }
        }
        
        function Save() {
            var data = $("form").serialize();

            $.post("{:U('add')}",data,function (res) {
                if (res.status == 1){

                }
            },"JSON");
        }
    </script>
</block>
